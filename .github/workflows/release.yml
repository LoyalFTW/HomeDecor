name: Release (Test Build)

on:
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Changelog.lua (writes to addon root)
        shell: bash
        run: bash -lc '
          set -euo pipefail
          TAG="$GITHUB_REF_NAME"
          DATE="$(date -u +%Y-%m-%d)"

          TOC_PATH="$(find . -maxdepth 3 -name "*.toc" | head -n 1)"
          [ -n "$TOC_PATH" ] || (echo "No .toc found" && exit 1)
          ADDON_DIR="$(dirname "$TOC_PATH")"

          PREV_TAG="$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || true)"
          if [ -n "$PREV_TAG" ]; then RANGE="${PREV_TAG}..${TAG}"; else RANGE="${TAG}"; fi

          CHANGES="$(git log "$RANGE" --no-merges --pretty=format:"- %s")"

          printf "HomeDecor_Changelog = [[\n# HomeDecor\n\n## %s (%s)\n\n%s\n\n]]\n" \
            "$TAG" "$DATE" "$CHANGES" > "$ADDON_DIR/Changelog.lua"

          echo "Wrote: $ADDON_DIR/Changelog.lua"
          sed -n "1,40p" "$ADDON_DIR/Changelog.lua"
        '

      - name: Package (no uploads)
        shell: bash
        run: |
          set -euo pipefail
          curl -sSL https://raw.githubusercontent.com/BigWigsMods/packager/master/release.sh -o release.sh
          chmod +x release.sh
          ./release.sh -d

      - name: Upload packaged zip as artifact
        uses: actions/upload-artifact@v4
        with:
          name: HomeDecor-TestBuild-${{ github.ref_name }}
          path: .release/*.zip
          if-no-files-found: error
