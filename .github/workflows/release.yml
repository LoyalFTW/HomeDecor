name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Package and Upload
        uses: BigWigsMods/packager@master
        env:
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          WOWI_API_TOKEN: ${{ secrets.WOWI_API_TOKEN }}
          WAGO_API_TOKEN: ${{ secrets.WAGO_API_TOKEN }}
          GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}

      - name: Announce on Discord
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          TAG: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          python - << 'PY'
          import os, json, urllib.request

          webhook = os.environ["DISCORD_WEBHOOK"]
          tag = os.environ["TAG"]
          repo = os.environ["REPO"]

          content = (
            f"ðŸ“¦ **New Release Published**\n"
            f"**{repo}** â€” `{tag}`\n"
            f"https://github.com/{repo}/releases/tag/{tag}"
          )

          data = json.dumps({"content": content}).encode("utf-8")
          req = urllib.request.Request(
              webhook,
              data=data,
              headers={"Content-Type": "application/json"}
          )
          urllib.request.urlopen(req).read()
          PY
