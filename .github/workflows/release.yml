name: Release

"on":
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Version.lua + Changelog.lua
        shell: bash
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME}"
          DATE="$(date -u +"%Y-%m-%d")"

          mkdir -p HomeDecor/Core

          cat > HomeDecor/Core/Version.lua <<EOF
-- Auto-generated. Do not edit.

HomeDecor_Version = {
  version = "${TAG}",
  date    = "${DATE}",
}
EOF

          PREV_TAG="$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || true)"
          if [ -n "${PREV_TAG}" ]; then
            RANGE="${PREV_TAG}..${TAG}"
          else
            RANGE="${TAG}"
          fi

          {
            echo "-- Auto-generated. Do not edit."
            echo
            echo "HomeDecor_Changelog = {"
            echo "  version = \"${TAG}\","
            echo "  date    = \"${DATE}\","
            echo "  changes = {"
            git log "${RANGE}" --no-merges --pretty=format:%s | while IFS= read -r line; do
              esc="${line//\\/\\\\}"
              esc="${esc//\"/\\\"}"
              printf "    \"%s\",\n" "$esc"
            done
            echo "  },"
            echo "}"
          } > HomeDecor/Core/Changelog.lua

      - name: Package and Upload
        uses: BigWigsMods/packager@master
        env:
          CF_API_KEY: '${{ secrets.CF_API_KEY }}'
          WOWI_API_TOKEN: '${{ secrets.WOWI_API_TOKEN }}'
          WAGO_API_TOKEN: '${{ secrets.WAGO_API_TOKEN }}'
          GITHUB_OAUTH: '${{ secrets.GITHUB_TOKEN }}'

      - name: Announce on Discord
        if: success()
        env:
          DISCORD_WEBHOOK: '${{ secrets.DISCORD_WEBHOOK }}'
          TAG: '${{ github.ref_name }}'
          REPO: '${{ github.repository }}'
        run: |
          payload=$(cat <<EOF
          {
            "content": "ðŸ“¦ **New Release Published**\n**${REPO}** â€” \`${TAG}\`\nhttps://github.com/${REPO}/releases/tag/${TAG}"
          }
          EOF
          )
          curl -sS -X POST \
            -H "Content-Type: application/json" \
            -H "User-Agent: HomeDecorReleaseBot (GitHub Actions)" \
            --data "$payload" \
            "${DISCORD_WEBHOOK}?wait=true"
